name: 'ğŸ¤– SARIFè‡ªåŠ¨ä¿®å¤Agent'

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      min_severity:
        description: 'æœ€å°ä¸¥é‡æ€§ç­‰çº§ (low, medium, high, critical)'
        required: true
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

  # å½“SARIFæ–‡ä»¶ä¸Šä¼ æ—¶è§¦å‘
  upload:
    paths:
      - '**/*.sarif'

  # PRè¯„è®ºè§¦å‘
  issue_comment:
    types: [created]

  # Pull Requestè§¦å‘
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'

env:
  PYTHON_VERSION: '3.9'

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£…uv
        run: |
          pip install uv

      - name: ğŸ“¦ å®‰è£…ä¾èµ– (ä½¿ç”¨uv)
        run: |
          uv pip install --system -e .

      - name: ğŸ“‚ åˆ›å»ºå·¥ä½œç›®å½•
        run: |
          mkdir -p ./sarif-files
          mkdir -p ./workflows
          mkdir -p ./fixes
          mkdir -p ./reports

      - name: ğŸ” æŸ¥æ‰¾SARIFæ–‡ä»¶
        id: find-sarif
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰SARIFæ–‡ä»¶
          find . -name "*.sarif" -type f > sarif_files.txt
          echo "sarif_count=$(wc -l < sarif_files.txt)" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ° $(wc -l < sarif_files.txt) ä¸ªSARIFæ–‡ä»¶"

          if [ $(wc -l < sarif_files.txt) -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ°SARIFæ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä¸Šä¼ äº†CodeQLæ‰«æç»“æœ"
            exit 1
          fi

      - name: ğŸ“‹ åˆ—å‡ºSARIFæ–‡ä»¶
        run: |
          echo "ğŸ“„ å‘ç°çš„SARIFæ–‡ä»¶:"
          cat sarif_files.txt

      - name: ğŸ”‘ è®¾ç½®Minimax APIå¯†é’¥
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        run: |
          if [ -z "$MINIMAX_API_KEY" ]; then
            echo "âŒ æœªè®¾ç½®MINIMAX_API_KEYå¯†é’¥"
            echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ åä¸ºMINIMAX_API_KEYçš„å¯†é’¥"
            exit 1
          fi
          echo "âœ… Minimax APIå¯†é’¥å·²è®¾ç½®"

      - name: ğŸ¤– è¿è¡Œè‡ªåŠ¨ä¿®å¤å¼•æ“
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        run: |
          echo "ğŸš€ å¯åŠ¨SARIFè‡ªåŠ¨ä¿®å¤å¼•æ“..."

          # ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·è¿è¡Œ
          sarif-fix \
            --sarif-dir ./sarif-files \
            --workflows-dir ./.github/workflows \
            --min-severity medium \
            --dry-run \
            --output-dir ./output

      - name: ğŸ“Š ç”Ÿæˆä¿®å¤æ‘˜è¦
        run: |
          echo "## ğŸ¤– SARIFè‡ªåŠ¨ä¿®å¤æ‘˜è¦" > fix_summary.md
          echo "" >> fix_summary.md
          echo "### ğŸ“ˆ ä¿®å¤ç»Ÿè®¡" >> fix_summary.md
          echo "- æ—¶é—´: $(date)" >> fix_summary.md
          echo "- SARIFæ–‡ä»¶æ•°: ${{ steps.find-sarif.outputs.sarif_count }}" >> fix_summary.md
          echo "" >> fix_summary.md

          if [ -f "auto_fix_report.json" ]; then
            echo "### âœ… ä¿®å¤ç»“æœ" >> fix_summary.md
            python -c "
            import json
            with open('auto_fix_report.json', 'r') as f:
                report = json.load(f)
            print(f'- æ€»æ¼æ´æ•°: {report[\"total_vulnerabilities\"]}')
            fixes = report['fixes']
            applied = sum(1 for f in fixes if f['applied'])
            failed = len(fixes) - applied
            print(f'- æˆåŠŸä¿®å¤: {applied}')
            print(f'- ä¿®å¤å¤±è´¥: {failed}')
            print(f'- ä¿®å¤ç‡: {(applied/len(fixes)*100):.1f}%' if fixes else '- ä¿®å¤ç‡: 0%')
            " >> fix_summary.md
          else
            echo "### âš ï¸ ä¿®å¤æŠ¥å‘Šæœªç”Ÿæˆ" >> fix_summary.md
          fi

      - name: ğŸ’¬ å‘å¸ƒè¯„è®º (PRè§¦å‘)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('fix_summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: ğŸ“ åˆ›å»ºIssue (æ‰‹åŠ¨è§¦å‘)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('fix_summary.md', 'utf8');

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– SARIFè‡ªåŠ¨ä¿®å¤æŠ¥å‘Š - ${new Date().toISOString().split('T')[0]}`,
              body: summary,
              labels: ['security', 'auto-fix', 'sarif']
            });

      - name: ğŸ“¤ ä¸Šä¼ ä¿®å¤æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sarif-fix-reports
          path: |
            auto_fix_report.json
            fix_summary.md
            chain_of_thought_*.json
          retention-days: 30

      - name: ğŸ“Š ä¸Šä¼ ä¿®å¤åçš„å·¥ä½œæµæ–‡ä»¶
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fixed-workflows
          path: .github/workflows/
          retention-days: 30

      - name: ğŸ”” é€šçŸ¥æˆåŠŸ
        if: success()
        run: |
          echo "âœ… SARIFè‡ªåŠ¨ä¿®å¤å®Œæˆï¼"
          echo "ğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹artifacts"
          echo "ğŸ” ä¿®å¤åçš„å·¥ä½œæµæ–‡ä»¶è¯·æŸ¥çœ‹ 'fixed-workflows' artifact"

      - name: ğŸ”” é€šçŸ¥å¤±è´¥
        if: failure()
        run: |
          echo "âŒ SARIFè‡ªåŠ¨ä¿®å¤å¤±è´¥"
          echo "ğŸ” è¯·æ£€æŸ¥æ—¥å¿—ä»¥äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› :"
          echo "  - SARIFæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"
          echo "  - Minimax APIå¯†é’¥æ— æ•ˆ"
          echo "  - å·¥ä½œæµæ–‡ä»¶æ— æ³•è§£æ"
